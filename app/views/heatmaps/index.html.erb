<div id="hack">
  <select id="regional">
    <option value="Australia">Australia</option>
    <option value="Perth">Perth</option>
    <option value="Adelaide">Adelaide</option>
    <option value="Melbourne">Melbourne</option>
    <option value="Hobart">Hobart</option>
    <option value="Canberra">Canberra</option>
    <option value="Sydney">Sydney</option>
    <option value="Brisbane">Brisbane</option>
    <option value="Darwin">Darwin</option>
  </select>
  <div id="controls">
    <ul>
      <li><a href="#hm1"><span>1</span></a></li>
      <li><a href="#hm2"><span>2</span></a></li>
      <li><a href="#hm3"><span>3</span></a></li>
    </ul>
    <div id="hm1">
      <select class="source"></select>
      <br/>
      <select class="subject"></select>
      <br/>
      <select class="measure"></select>
      <br/>
      <input type="radio" class="enabled" checked="checked">
      <label>Display</label>
    </div>
    <div id="hm2">
      <input type="radio" class="enabled" checked="checked">
      <label>Display</label>
      <br/>
      <select class="source"></select>
      <br/>
      <select class="subject"></select>
      <br/>
      <select class="measure"></select>
    </div>
    <div id="hm3">
      <input type="radio" class="enabled" checked="checked">
      <label>Display</label>
      <br/>
      <select class="source"></select>
      <br/>
      <select class="subject"></select>
      <br/>
      <select class="measure"></select>
    </div>
  </div>
  <div id="info">
    <button id="tools">Tools</button>
    <button id="share">Share</button>
    <span id="blurb"></span>
  </div>
  <div class="map">
  </div>
</div>
<div id="welcome" title="Australian Government Exposed!">
  <p>Welcome to <a href="http://hackerspace.govhack.org/content/national-eyeball">my entry</a> to GovHack 2014.</p>
  <p><i>National Eyeball</i> allows you to</p>
  <ul>
    <li>create a heatmap to eyeball government data;</li>
    <li>share your heatmap on Twitter; and</li>
    <li>check out <a href="http://api.govdata.exposed/australia">api.govdata.exposed/australia</a>.</li>
  </ul>
  <p>Sources: ABS, ATO, AIHW, WAEC, PTA, DoHA and DOE.<p>
</div>

<script>
  HeatMap = {};
  HeatMap.state = {
    bounds: [0, 0, 0, 0],
    filters: [262,269,5],
    colours: [[255,0,0],[0,255,0],[0,0,255]],
    dirty: false,
    viewing: "Australia"
  };
  HeatMap.instances = [];

  ZOOMS = {
    "Australia": {
      center: new google.maps.LatLng(-28, 134),
      zoom: 5
    },
    "Perth": {
      center: new google.maps.LatLng(-32, 116),
      zoom: 10
    },
    "Adelaide": {
      center: new google.maps.LatLng(-35, 139),
      zoom: 10
    },
    "Melbourne": {
      center: new google.maps.LatLng(-38, 145),
      zoom: 9
    },
    "Hobart": {
      center: new google.maps.LatLng(-42.9, 147.2),
      zoom: 11
    },
    "Canberra": {
      center: new google.maps.LatLng(-35.3, 149),
      zoom: 11
    },
    "Sydney": {
      center: new google.maps.LatLng(-34, 151),
      zoom: 9
    },
    "Brisbane": {
      center: new google.maps.LatLng(-27, 153),
      zoom: 9
    },
    "Darwin": {
      center: new google.maps.LatLng(-12.4, 130.8),
      zoom: 11
    }
  }

  map_options = {
    panControl: false,
    zoomControl: true,
    mapTypeControl: true,
    scaleControl: true,
    streetViewControl: false,
    overviewMapControl: false,
    scrollwheel: false,
    center: ZOOMS[HeatMap.state.viewing].center,
    zoom: ZOOMS[HeatMap.state.viewing].zoom
  };

  function update_bounds() {
    if (!HeatMap.state.dirty) {
      return;
    }
    HeatMap.state.dirty = false;
    HeatMap.state.bounds[0] = map.getBounds().getSouthWest().lat();
    HeatMap.state.bounds[1] = map.getBounds().getSouthWest().lng();
    HeatMap.state.bounds[2] = map.getBounds().getNorthEast().lat();
    HeatMap.state.bounds[3] = map.getBounds().getNorthEast().lng();
    redraw_heatmaps();
  }

  function display_heatmaps() {
    _.each(HeatMap.points, function(points, index){
      if (_.isUndefined(HeatMap.instances[index])) {
        HeatMap.instances[index] = new google.maps.visualization.HeatmapLayer({
          map: null,
          radius: 0.03,
          dissipating: false,
          opacity: 0.8,
          maxIntensity: 1.0,
        });
      }
      gradient = [];
      _.times(14, function(i){
        c = HeatMap.state.colours[index];
        a = i/13.0;
        gradient.push("rgba("+c[0]+","+c[1]+","+c[2]+","+a+")");
      });
      HeatMap.instances[index].set('gradient', gradient);
      points = _.map(HeatMap.points[index], function(point){
        return {
          location: new google.maps.LatLng(point.lat,point.lng),
          weight: point.weight
        }
      });
      HeatMap.instances[index].setData(points);
      if (map.zoom >= 13) {
        HeatMap.instances[index].setMap(null);
      } else if (_.isNull(HeatMap.instances[index].map)) {
        HeatMap.instances[index].setMap(map);
      }
    });
  }

  function display_comments() {
    $("#blurb").text(HeatMap.comments.comment);
  }

  function redraw_heatmaps() {
    if (HeatMap.state.filters.length > 0) {
      $.getJSON("heatmaps/points", HeatMap.state, function(data){
        HeatMap.points = data;
        display_heatmaps();
      });
      $.getJSON("heatmaps/comments", HeatMap.state, function(data){
        HeatMap.comments = data;
        display_comments();
      });
    }
  }

  function initialize_controls() {
    $.getJSON("heatmaps/filters", function(data){
      HeatMap.filters = data;
      $("select.source").change(function(event){
        subject = $(event.target).parent()[0].id;
      });
      $("select.subject").change(function(event){
        event.target;
      });
      $("select.measure").change(function(event){
        event.target;
      });
      _.each(data, function(item, value){
        option = '<option value=' + value + '>' + item.name + '</option>';
        $('select.source').append(option);
      });
    });
    $("select#regional").change(function(event){
      region = ZOOMS[$("#regional").val()];
      map.setCenter(region.center);
      map.setZoom(region.zoom);
    });
  }

  function initialize() {
    $("#controls").tabs();
    $("#info").tabs();
    $("#tools").button().click(function(){
      $("#controls").toggle();
    });
    $("#share").button().click(function(){
      console.log("TODO: twitter");
    });
    $("#welcome").dialog({
      width: 600,
      height: 300,
      buttons: [
        {
          text: "OK",
          click: function() {
            $(this).dialog("close");
            initialize_controls();
          }
        }
      ]
    });
    map = new google.maps.Map($("#hack .map")[0], map_options);
    google.maps.event.addListener(map, 'idle', update_bounds);
    google.maps.event.addListener(map, "bounds_changed", function(){
      HeatMap.state.dirty = true;
    });
  }

  google.maps.event.addDomListener(window, 'load', initialize);
</script>

<% content_for :head do %>
  <%= javascript_include_tag '//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js' %>
  <%= javascript_include_tag '//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js' %>
  <%= javascript_include_tag "//maps.googleapis.com/maps/api/js?libraries=geometry,drawing,visualization&sensor=false" %>
  <%= javascript_include_tag "//underscorejs.org/underscore-min.js" %>
  <%= stylesheet_link_tag "//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" %>
  <style>
    html {
      height: 100%;
      margin: 0px;
      padding: 0px;
    }
    body {
      height: 100%;
      margin: 0px;
      padding: 0px;
    }
    div#hack {
      width: 100%;
      height: 100%;
      margin: 0px;
    }
    div.map {
      width: 100%;
      height: 100%;
      margin: 0px;
    }
    div#controls {
      display: none;
      position: fixed;
      bottom: 76px;
      left: 1px;
      width: 175px;
      height: 200px;
      z-index: 999;
      opacity: 0.7;
    }
    div#info {
      position: fixed;
      bottom: 30px;
      left: 0px;
      width: 100%;
      height: 38px;
      z-index: 999;
      opacity: 0.7;
    }
    select#regional {
      position: fixed;
      top: 5px;
      right: 105px;
      width: 100px;
      z-index: 999;
      opacity: 0.7;
    }
    span#blurb {
      padding-left: 10px;
    }
  </style>
<% end %>
